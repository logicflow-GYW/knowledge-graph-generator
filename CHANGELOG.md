# 更新日志 (Changelog)

所有本插件的重要变更都将记录在此。
---

## [1.7.1] - 2025-11-13

### 🐞 修复 (Fixed)

* **修复了 API 故障切换的严重逻辑漏洞：**
    1.  修复了当“主模型”为空或返回 404 错误时，系统**无法**切换到“备用模型”的致命问题。
    2.  修复了当 API 返回速率限制（429 错误）时，API Key **无法**被正确冷却和轮换，导致引擎卡住的问题。
* **修复了配置错误导致的“刷屏”：** 当用户提供了 API 密钥但*未*指定模型名称时，插件现在会静默跳过该供应商，而不是为每个 Key 都弹出 404 错误通知。
* **修复了 AI 审核器：** 在“AI 审核”模式下，用于解析 AI 返回 `[REASON: ...]` 的逻辑现在不区分大小写，提高了其健壮性。

### 🚀 优化 (Improvements)

* **优化了模型切换体验：** 移除了在高频速率限制（429）下，主模型切换到备用模型时弹出的（“打扰”）通知，使切换过程更加静默。

### 🧹 内部 (Internal)

* **代码健康：** 同步了 `types.ts` 与 `settings.ts` 中的所有配置项（如 `openai_backup_model`, `extract_new_concepts` 等），确保了类型安全和可维护性。

---

## [1.7.0] - 2025-11-08

### ✨ 新功能 (Features)

* **API 备用模型支持：** 新增了 OpenAI 和 Google Gemini 的“备用模型”设置。当主模型因额度耗尽或特定错误失败时，插件将自动尝试使用您指定的备用模型（例如，主模型 `gpt-4-turbo` 失败后，自动尝试 `gpt-3.5-turbo`），大幅提升了生成任务的成功率和健壮性。
* **新概念自动提取：** 在设置中新增“自动提取新概念”开关（默认关闭）。启用后，插件会在一篇笔记通过“审核”阶段并被保存时，自动解析其内容中的所有 `[[Wikilinks]]`，并将这些链接作为新概念添加回“待生成队列”中，实现了知识网络的自动化扩展。

### 🚀 优化 (Improvements)

* **队列仪表盘性能优化：** “队列管理仪表盘”现已支持对每个队列（待生成、待审核等）进行**实时搜索过滤**。
* **队列仪表盘渲染优化：** 优化了长列表的渲染性能。现在，每个队列默认只显示前 100 个项目并提供滚动条，即使队列中有数千个待处理项目，也能流畅地打开和管理。
* **内容自动净化：** 插件现在会自动清理 AI 返回内容中多余的 markdown 代码块（即 ` ```markdown ... ``` ` 包装），确保最终保存到笔记中的内容格式干净、统一。
* **新增模型切换通知：** 当主模型切换到备用模型时，系统会弹出一个明确的通知（例如：“模型 gpt-4 失败，自动尝试备用模型 gpt-3.5...”），让您能实时了解插件的状态。

### 🐞 修复 (Fixed)

* 重构了 API 错误处理逻辑，增强了对 API 额度（429、401）和权限类错误的识别，配合备用模型机制，显著降低了因单个 Key 失败导致整个引擎暂停的概率。

---

## [1.6.0] - 2025-11-08

### ✨ 新功能 (Features)

* **API 备用模型支持 (Backup Models):**
    * 现在可以在设置中为 OpenAI 和 Google Gemini 分别指定一个“备用模型”。
    * 当主模型（例如 `gpt-4-turbo`）因为额度耗尽或速率限制而失败时，插件会**自动尝试使用您设置的备用模型**（例如 `gpt-3.5-turbo`）来完成该任务，然后再对该 API 密钥进行冷却或切换。这极大地增强了插件长时间自动运行的稳定性。
* **新概念自动提取 (知识循环):**
    * 在“引擎设置”中新增了“自动提取新概念”开关（默认关闭）。
    * 开启后，当一篇笔记被“审核”阶段批准时，插件会自动解析该笔记内容中的所有 `[[Wikilinks]]`。
    * 这些被提取的链接（如果尚不存在）将被作为新概念，自动添加回“待生成队列”，从而实现知识图谱的自我循环与扩展。

### 🚀 优化 (Improvements)

* **API 错误处理重构:**
    * 对内部 API 处理器 (API Handler) 进行了重构，将 API 请求、额度/权限错误检查 (isQuotaError) 和密钥冷却 (Cooldown) 逻辑拆分到更清晰的辅助函数中，以更稳定地支持新的“备用模型”故障切换功能。

---

## [1.5.4] - 2025-11-08

### ✨ 新功能 (Features)

* **自动提取新概念：** 在设置中新增了“自动提取新概念”的开关（默认关闭）。
* **功能说明：** 开启后，插件将在笔记通过“审核 (Critic)” 阶段时，自动解析笔记内容中的 `[[Wikilinks]]`，并将这些链接作为新概念添加到“待生成队列”中，实现了知识图谱的自动“播种”和扩展。

---

## [1.5.3] - 2025-11-08

### 🚀 优化 (Improvements)

* **API 故障切换通知：** 当所有 OpenAI Key 均失败时，插件现在将弹出一个**明确的通知**（例如“正在切换到 Google Gemini...”），而不是静默切换。此通知只会显示一次，以避免重复打扰。
* **队列仪表盘优化：** “队列管理仪表盘”现在打开时默认将所有队列（待生成、待审核等）**全部折叠**，使界面更加干净整洁，尤其便于管理大量任务。
* **设置描述更新：** 在设置面板中为“最大并发数”添加了注释，明确告知用户 V2.2 引擎暂不支持并发设置，避免用户困惑。

### 🐞 修复 (Fixed)

* **数据稳定性重构：** 彻底重构了数据保存逻辑。现在，插件的配置 (`settings`) 和运行时的队列数据 (`data`) 将作为一个单独的对象被**原子性地保存**。这极大地提高了数据一致性，能有效防止在插件或 Obsidian 意外退出时导致的数据损坏或丢失问题。

---

## [1.5.2] - 2025-11-08

### 🚀 优化 (Improvements)

* **队列仪表盘优化：** “队列管理仪表盘”现在打开时默认将所有队列（待生成、待审核等）折叠，使界面更加干净整洁。
* **API 故障切换：** 优化了 API 故障切换通知逻辑。现在只有在**首次**从一个 API供应商 (如 OpenAI) 切换到另一个 (如 Gemini) 时才会弹出通知，避免了在 API 密钥轮换时造成重复打扰。

### 🐞 修复 (Fixed)

* 提升了插件运行的整体健壮性
  
---

## [1.5.1] - 2025-11-08

### 🚀 优化 (Improvements)

* **队列仪表盘优化：** “队列管理仪表盘”现在打开时默认将所有队列（待生成、待审核等）折叠，使界面更加干净整洁。
* **API 故障切换：** 优化了 API 故障切换通知逻辑。现在只有在**首次**从一个 API供应商 (如 OpenAI) 切换到另一个 (如 Gemini) 时才会弹出通知，避免了在 API 密钥轮换时造成重复打扰。

### 🐞 修复 (Fixed)

* 提升了插件运行的整体健壮性。
